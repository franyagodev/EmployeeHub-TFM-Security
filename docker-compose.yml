services:
  # Base de Datos
  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: 123456abc
      MYSQL_DATABASE: employee_db
      TZ: 'America/Mexico_City'
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123456abc"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Eureka Server
  service-registry:
    build: ./service-registry
    container_name: service-registry
    ports:
      - "8761:8761"
    environment:
      - eureka.client.register-with-eureka=false
      - eureka.client.fetch-registry=false
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Config Server
  config-server:
    build: ./config-server
    container_name: config-server
    ports:
      - "8088:8088"
    environment:
      - eureka.client.serviceUrl.defaultZone=http://service-registry:8761/eureka/
      - spring.cloud.config.server.git.clone-on-start=true
    networks:
      - microservices-network
    depends_on:
      service-registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # API Gateway
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8080:8060"
    environment:
      - spring.cloud.config.uri=http://config-server:8088
      - eureka.client.serviceUrl.defaultZone=http://service-registry:8761/eureka/
      - eureka.instance.prefer-ip-address=true
    networks:
      - microservices-network
    depends_on:
      service-registry: { condition: service_healthy }
      config-server: { condition: service_healthy }

  # Auth Service
  auth-service:
    build: ./auth-service
    container_name: auth-service
    ports:
      - "8071:8053"
    environment:
      - spring.datasource.url=jdbc:mysql://mysql:3306/auth_db
      - spring.datasource.username=root
      - spring.datasource.password=123456abc
      - spring.cloud.config.uri=http://config-server:8088
      - eureka.client.serviceUrl.defaultZone=http://service-registry:8761/eureka/
      - eureka.instance.prefer-ip-address=true
    networks:
      - microservices-network
    depends_on:
      mysql: { condition: service_healthy }
      service-registry: { condition: service_healthy }
      config-server: { condition: service_healthy }

  # City Service
  city-service:
    build: ./city-service
    container_name: city-service
    ports:
      - "8093:8050"
    environment:
      - spring.datasource.url=jdbc:mysql://mysql:3306/city_db
      - spring.datasource.username=root
      - spring.datasource.password=123456abc
      - spring.cloud.config.uri=http://config-server:8088
      - eureka.client.serviceUrl.defaultZone=http://service-registry:8761/eureka/
      - eureka.instance.prefer-ip-address=true
    networks:
      - microservices-network
    depends_on:
      mysql: { condition: service_healthy }
      service-registry: { condition: service_healthy }
      config-server: { condition: service_healthy }

  # Department Service
  department-service:
    build: ./department-service
    container_name: department-service
    ports:
      - "8052:8083"
    environment:
      - spring.datasource.url=jdbc:mysql://mysql:3306/department_db
      - spring.datasource.username=root
      - spring.datasource.password=123456abc
      - spring.cloud.config.uri=http://config-server:8088
      - eureka.client.serviceUrl.defaultZone=http://service-registry:8761/eureka/
      - eureka.instance.prefer-ip-address=true
    networks:
      - microservices-network
    depends_on:
      mysql: { condition: service_healthy }
      service-registry: { condition: service_healthy }
      config-server: { condition: service_healthy }

  # Employee Service
  employee-service:
    build: ./employee-service
    container_name: employee-service
    ports:
      - "8090:8082"
    environment:
      - spring.datasource.url=jdbc:mysql://mysql:3306/employee_db
      - spring.datasource.username=root
      - spring.datasource.password=123456abc
      - spring.cloud.config.uri=http://config-server:8088
      - eureka.client.serviceUrl.defaultZone=http://service-registry:8761/eureka/
      - eureka.instance.prefer-ip-address=true
    networks:
      - microservices-network
    depends_on:
      mysql: { condition: service_healthy }
      service-registry: { condition: service_healthy }
      config-server: { condition: service_healthy }

networks:
  microservices-network:
    driver: bridge

volumes:
  mysql_data: